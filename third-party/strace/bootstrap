#!/bin/sh

set -o errexit nounset

./m4/gen_bpf_attr_m4.sh
./generate_mpers_am.sh
./xlat/gen.sh
./tests/gen_pure_executables.sh
./tests/gen_tests.sh

for m in m32 mx32; do
	tests="tests-$m"
	s='[[:blank:]]*'
	k="s/^\\(SIZEOF_KERNEL_LONG_T$s=\\).*/\\1 4/"

	rm -rfv -- "$tests"
	mkdir -pv -- "$tests"

	if [[ "$m" != m32 ]]; then
		k=
	fi

	sed "s/@arch@/@arch_$m@/;
	     s/^\\(SIZEOF_LONG$s=\\).*/\\1 4/;
	     $k;
	     s/^MPERS_NAME$s=.*/& $m/;
	     s/^MPERS_CC_FLAGS$s=.*/& @cc_flags_$m@/;
	     s/^ARCH_MFLAGS$s=.*/& -DMPERS_IS_\$(MPERS_NAME) \$(MPERS_CC_FLAGS)/;
	     " tests/Makefile.am > "$tests/Makefile.am"

	for f in tests/*; do
		if [[ "${f##*/}" != Makefile* ]]; then
			ln -sv -- "../$f" "$tests/"
		fi
	done
done

if [[ -f dist/README ]]; then
	cp -v dist/README ./
fi

autoreconf -f -i "$@"
