AR ?= ar
CC ?= gcc
LD := gcc
LIBS_PATH := ./libs/
CPPFLAGS += -D_GNU_SOURCE=1 -D__STDC_FORMAT_MACROS=1
CPPFLAGS += -D_POSIX_C_SOURCE=199506 -D_XOPEN_SOURCE=600
CPPFLAGS += -DHAVE_CONFIG_H -D_BSD_SOURCE=1 -DLIBPRINTSTRACE_COMPILE
CFLAGS += -g3 -Wall -Wextra -pedantic -std=gnu99 -fPIC -melf_i386
CFLAGS += -Wno-long-long -Wno-unused-parameter -fuse-ld=gold
CFLAGS += -Wno-missing-field-initializers -fno-omit-frame-pointer
CFLAGS += -fdiagnostics-show-option -I./ -I./linux -I./linux/i386
LDFLAGS += -fuse-ld=gold -g3 -rdynamic -fPIC -melf_i386
LDLIBS += -L$(LIBS_PATH) -lrt

EXCLUDE_OBJS := strace-main.o strace-statfs64.o strace-main.o strace-ucopy.o
OBJECTS = $(wildcard *.o)
NEW_OBJS = $(filter-out $(EXCLUDE_OBJS),$(OBJECTS))

all:
	$(MAKE) libstrace.so libprintstrace.a

.PHONY: all clean main print_vars

print_vars:
	@echo $(NEW_OBJSa)

libstrace.so: $(NEW_OBJS) strace.o
	$(LD) $< $(LDFLAGS) -shared -Wl,soname,$@.1 -o $@.1.0.1
	@mkdir -pv $(LIBS_PATH)/
	@cp -fv $@.1.0.1 $(LIBS_PATH)/
	@ln -sfv $(LIBS_PATH)/$@.1.0.1 $(LIBS_PATH)/$@.1
	@ln -sfv $(LIBS_PATH)/$@.1.0.1 $(LIBS_PATH)/$@

libprintstrace.a: $(NEW_OBJS)
	$(AR) rcs $@ $(NEW_OBJS)

strace-main: strace-main.o
	$(LD) $(LDFLAGS) $^ $(LDLIBS) -o $@

strace-main.o: main.c
	$(CC) $(CPPFLAGS) $(CFLAGS) -c $< -o $@

strace-lib.o: strace.c
	$(CC) $(CPPFLAGS) $(CFLAGS) -c $< -o $@

%.o: %.c
	$(CC) $(CPPFLAGS) $(CFLAGS) -c $< -o $@

clean:
	$(RM) -fv *.o
	$(RM) -fv *.a
	$(RM) -fv *.so
	$(RM) -fv strace-main

# vi:ft=make:
